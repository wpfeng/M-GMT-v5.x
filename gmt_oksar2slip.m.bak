function gmt_oksar2slip(varargin)
%
%
% Fig_4_slipmodel2D
% working for Burma
% Write by W.P, Feng, 2011-11-10, @ GU
% rewrite it into a function, which allow user to input any oksar file
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
oksar     = '../oksar/Burma_EQ6.8_distribution_2tracksv1.oksar';
zone      = '47 Q';
threshold = 0.4;
xpatchsize = 10;
ypatchsize = 10;
vconmin   = 5;
vconmax   = 50;
usgsloc   = [99.822,20.687,8]; %[90.320,29.761,12];%
gmt_snew  = 'sNeW';
gmt_outps = 'test.ps';
gmt_iscon = 0;
gmt_xoff  = '5i';
gmt_yoff  = '5i';
gmt_figlable = 'A';
gmt_isov     = 0;
azim         = [];
%
gmt_usgsoffx = 0;
gmt_usgsoffy = 0;
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
gmt_proj      = ' -JX6i/2i ';
incpt         = 'D:\mdbase\users\others\gmt_mcodes\cpt\slipmodel.cpt';
cpt_isreverse = 1;
zinterv       = 0.02;
conzinterv    = 5;
scaleresample = 6;
%
vmin          = 0;
vmax          = 50;
gmt_cptname   = 'slip.cpt';
gmt_velscale  = '0.3';
slipxtitle    = 'Length(km)';
slipytitle    = 'Depth(km)';
cyoffset      = '0.25i';
cxoffset      = '4.0i';
clength       = '0.6i';
cwidth        = '0.025i';
ctitle        = 'Slip(m)';
czinterv      = '20';
cunit         = '';
dmproj        = ' -JX';
dmxwin        = '0.9i';
dmywin        = '0.9i';
dmxoff        = '2.7i';
dmyoff        = '0i';
dmsnew        = 'SE';
dmscale       = 10^17;
dmaxstep      = '20';
dmaystep      = '10';
dmxtitle      = 'Moment(10@+17 @-N.m)';
precision     = 0.001;
textsize      = '8';
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
v = sim_varmag(varargin);
for j = 1:length(v)
    %disp(v);
    eval(v{j});
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
uzone = sim_oksar2utm(oksar);
if isempty(uzone)==0
    zone = uzone;
end
%
[x,y]     = deg2utm(usgsloc(2),usgsloc(1),zone);
ux        = x./1000;
uy        = y./1000;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
fpara = sim_oksar2SIM(oksar);
if isempty(azim)==1
    azim = mean(fpara(:,3));
end
%
slippatch  = 'slippatch.dat';
sliparrow  = 'sliparrow.dat';
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
fidslippatch = fopen(slippatch,'w');
fidsliparrow = fopen(sliparrow,'w');
%
data1 = [];
data2 = [];
%
[ux0,uy0] = eqs_rotaxs(ux,uy,azim);
ux        = ux0;
uy        = uy0;
%[azim,ux0,uy0]
%
%
for ni = 1:numel(fpara(:,1))
    p           = sim_fpara2allcors(fpara(ni,:));
    veldata     = p(5,:);
    %[cx,cy]     = eqs_rotaxs(veldata(1),veldata(2),azim,[ux,uy]);
    [cx,cy]     = eqs_rotaxs(veldata(1),veldata(2),azim);
    %cx          = veldata(2);
    %
    %
    slip  = sqrt(fpara(ni,8).^2 + fpara(ni,9).^2);
    data1 = [data1;cx,veldata(3).*-1,slip];
    data2 = [data2;cx,veldata(3).*-1,fpara(ni,8),fpara(ni,9),0,0,0.0001];
    %
    
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%data1
data1(:,1) = data1(:,1)-ux;
data2(:,1) = data2(:,1)-ux;
data2(:,2) = data2(:,2)-max(data2(:,2));
data2      = data2(data1(:,3)>threshold,:);
flag1      = rem(fix(data2(:,1)),scaleresample);
flag2      = rem(fix(data2(:,2)),scaleresample);
flag       = flag1+flag2;
data2      = data2(flag==0,:);
%%%%%%%%%%%%%%%%%%%%%%%%%%
td         = data1(data1(:,3)==max(data1(:,3)),1:2);
tmx        = td(1,1);
tmy        = td(1,2);
%%%%%%%%%%%%%%%%%%%%%%%%%%
fprintf(fidslippatch,'%f %f %f\n',data1');
fprintf(fidsliparrow,'%f %f %f %f %f %f %f\n',data2');
fclose(fidslippatch);
fclose(fidsliparrow);
%
xmin = floor(min(data1(:,1)));
ymin = floor(min(data1(:,2)));
xmax = ceil(max(data1(:,1)));
ymax = ceil(max(data1(:,2)));
%
mregion = [' -R',num2str(xmin),'/',num2str(xmax),'/',num2str(ymin),'/',num2str(ymax)];
outgrd  = 'slip.grd';
xyzgrdstr = ['xyz2grd ',slippatch,' ',mregion,' -N0 -G',outgrd,'  -I',num2str(xpatchsize),'/',num2str(ypatchsize)];
disp(xyzgrdstr);
system(xyzgrdstr);
%
gmt_gmtset(...
    'gmt_color_foreground','255/255/255',...
    'gmt_color_background','0/0/0');
%
gmt_makecpt('gmt_colorn',incpt,'gmt_cptname',gmt_cptname,'gmt_logrithm','  ',...
    'gmt_zstart',vmin,'gmt_isreverse',cpt_isreverse,...
    'gmt_zend',vmax,'gmt_zinterv',zinterv,'gmt_iscontin',1)
gmt_grdimage(outgrd,...
    'gmt_isov',gmt_isov,...
    'gmt_iscon',1,...
    'gmt_proj',gmt_proj,...
    'gmt_mregion',mregion,...
    'gmt_outps',gmt_outps,...
    'gmt_zinterv',czinterv,...
    'gmt_axstep','50f50',...
    'gmt_yoff',gmt_yoff,...
    'gmt_xoff',gmt_xoff,...
    'gmt_xtitle',slipxtitle,...
    'gmt_ytitle',slipytitle,...
    'gmt_aystep','10f10',...
    'gmt_colorbarwidth',cwidth,...
    'gmt_snew',gmt_snew,...
    'gmt_unit',cunit,...
    'gmt_colorbarxoffset',cxoffset,...
    'gmt_colorbaryoffset',cyoffset,...
    'gmt_colorbarxtitle',ctitle,...
    'gmt_colorbarlength',clength,...
    'gmt_cptname',gmt_cptname);
%
gmt_psxy4points(...
    [0,usgsloc(3).*-1],...
    'gmt_proj',' -J ',...
    'gmt_xwid','',...
    'gmt_ywid','',...
    'gmt_xoff','0i',...
    'gmt_yoff','0i',...
    'gmt_outps',gmt_outps,...'
    'gmt_isov',1,...
    'gmt_iscon',1,...
    'gmt_snew','',...
    'gmt_xastep','',...
    'gmt_yastep','',...
    'gmt_xtitle','',...
    'gmt_ytitle','',...
    'gmt_pfillc','255/0/0',...
    'gmt_linecolor','/0/0/0',...
    'gmt_ptype','a',...
    'gmt_psize','0.2c',...
    'gmt_mregion',' -R ',...
    'iscon',1);
%
gmt_psxy4points(...
    [tmx,tmy],...
    'gmt_proj',' -J ',...
    'gmt_xwid','',...
    'gmt_ywid','',...
    'gmt_xoff','0i',...
    'gmt_yoff','0i',...
    'gmt_outps',gmt_outps,...'
    'gmt_isov',1,...
    'gmt_iscon',1,...
    'gmt_snew','',...
    'gmt_xastep','',...
    'gmt_yastep','',...
    'gmt_xtitle','',...
    'gmt_ytitle','',...
    'gmt_pfillc','255/255/255',...
    'gmt_linecolor','/0/0/0',...
    'gmt_ptype','a',...
    'gmt_psize','0.3c',...
    'gmt_mregion',' -R ',...
    'iscon',1);
%
gmt_pstext(...
    'text_x',num2str(gmt_usgsoffx),...
    'text_y',num2str(usgsloc(3)*-1+gmt_usgsoffy),...
    'text_string','USGS',...
    'text_outps',gmt_outps,...
    'text_fontcolor','0/0/0',...
    'text_backcolor','',...
    'text_size','6',...
    'text_fontno','2',...
    'text_edgewidth','0');
%
gmt_makecpt('gmt_colorn',incpt,'gmt_cptname',gmt_cptname,'gmt_logrithm','  ',...
    'gmt_zstart',vconmin,'gmt_isreverse',cpt_isreverse,...
    'gmt_zend',vconmax,'gmt_zinterv',conzinterv,'gmt_iscontin',1)
%
% pscontour
gmt_pscontour(slippatch,...
    'gmt_outps',gmt_outps,...
    'gmt_cptname',gmt_cptname,...
    'gmt_proj',gmt_proj,...
    'gmt_mregion', mregion,...
    'gmt_iscon',1,...
    'gmt_conlw','2p',...
    'gmt_concol','/50/50/50,--',...
    'gmt_lables','5');
% psvelo
gmt_psvelo('gmt_datainp',sliparrow,...
    'gmt_outps',gmt_outps,...
    'gmt_lwid', '0.0001c',...
    'gmt_iscon',1,...
    'gmt_scale',gmt_velscale,...
    'gmt_arrowtype','0.01/0.1/0.05',...
    'gmt_lcolor','/50/50/50',...
    'gmt_fcolor','200/200/200');
%%%%%%%%%%%%%%%%%
% A
gmt_pstext(...
    'text_x',num2str(xmin),...
    'text_y',num2str(ymin),...
    'text_string',gmt_figlable,...
    'text_outps',gmt_outps,...
    'text_fontcolor','255/255/255',...
    'text_backcolor','0/0/0',...
    'text_iscon',gmt_iscon,...
    'text_size',textsize);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%